---
description: Analyze codebase for compute inefficiencies common in AI research
argument-hint: "[path]"
allowed-tools: Glob, Read, Write, Task
---

# Compute Efficiency Analysis

Analyze Python codebase for compute inefficiencies common in AI/ML research workflows.

## Phase 1: Discover Files

Determine the target directory:
- If `$ARGUMENTS` is provided, use that path
- Otherwise, use the current working directory

Use Glob to find all Python files and Jupyter notebooks:
- Pattern: `**/*.py` in target directory
- Pattern: `**/*.ipynb` in target directory

Count the files found. If no Python or notebook files are found:
- Report to the user: "No Python or Jupyter notebook files found in [directory]. Nothing to analyze."
- Stop execution - do not create a report file.

## Phase 2: Load Anti-Pattern Catalog

Read the compute anti-pattern catalog for reference:

@${CLAUDE_PLUGIN_ROOT}/references/compute-antipatterns.md

This catalog contains known inefficiency patterns organized by category with detection heuristics and fixes.

## Phase 3: Spawn Analysis Agent

Use the Task tool to spawn an analysis agent with subagent_type "general-purpose".

Provide the agent with:
1. The list of Python files and notebooks found in Phase 1
2. The anti-pattern catalog content from Phase 2
3. The report format specification below

**Agent prompt:**

```
You are a compute efficiency analyst for AI research codebases. Your task is to identify inefficiencies that waste compute resources or money.

## Files to Analyze
[Include the file list from Phase 1]

## Anti-Pattern Reference
[Include the catalog content from Phase 2]

## Your Task

1. First, determine the codebase type:
   - **Local GPU**: Loads models locally (transformers, torch.load, etc.)
   - **API-based**: Uses external APIs (OpenAI, Anthropic, Together, LiteLLM, etc.)
   - **Hybrid**: Both local models and API calls

2. Read each Python file and Jupyter notebook

3. For each actual issue found, record:
   - File path and line number(s)
   - Severity (Critical / High / Medium / Low)
   - Problem description (what's wrong and the concrete cost/time impact)
   - The problematic code snippet
   - Suggested fix with corrected code

4. For local GPU codebases, estimate VRAM requirements

## Critical Output Rules

- **ONLY report actual problems that need fixing**
- **DO NOT mention patterns that "don't apply"** - just skip them silently
- **DO NOT reference the anti-pattern catalog** in your output - users don't need to know about it
- **DO NOT explain what you checked** - only report what you found
- If no issues are found, write a brief report saying "No significant efficiency issues found" with no further explanation
- Be direct and actionable - every issue in the report should be something the user should fix

## Output

Write the report to a file named: efficiency_report_[TODAY'S DATE].md

Use today's date in yyyy-mm-dd format (e.g., efficiency_report_2024-01-15.md).

Use this report format:

---

# Compute Efficiency Analysis Report

**Generated:** [date]
**Directory analyzed:** [path]
**Files analyzed:** X Python files, Y Jupyter notebooks

---

## Resource Estimation Summary

**Detected workflow:** [inference / training / activation collection / probing / etc.]

**Models detected:**
- [model-name]: ~[X]GB VRAM ([precision])

**Estimated minimum VRAM:** [X]GB
**Recommended VRAM (with overhead):** [X]GB

---

## Issues Found

### Critical Issues

#### [Brief title]

**Location:** `path/to/file.py:123-125`

**Problem:**
[Clear explanation of what's inefficient and the concrete impact]

**Current code:**
```python
[the problematic code]
```

**Suggested fix:**
```python
[the corrected code]
```

---

### High Severity Issues

[Same format as Critical]

### Medium Severity Issues

[Same format]

(Omit any severity section that has no issues)

---

## Summary Recommendations

**Priority fixes (highest impact first):**
1. [Most impactful fix] - [estimated benefit]
2. [Second most impactful] - [estimated benefit]
3. [Third] - [estimated benefit]

**Estimated total impact:**
- Memory reduction: ~[X]GB (if applicable)
- Speed improvement: ~[X]x (if applicable)

---

*Generated by /efficiency-check*
```

## Phase 4: Confirm Completion

After the agent completes, confirm to the user:
- The report file location
- Summary of issues found (counts by severity)
- Top recommendation if any critical issues were found
